<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Identity Services - Multi-Account Demo</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px;
            border-radius: 4px;
        }

        .info-box h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .info-box ul {
            margin-left: 20px;
            color: #1976d2;
        }

        .info-box code {
            background: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }

        .main-content {
            padding: 30px;
        }

        .config-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #4285f4;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            background: #34a853;
            color: white;
        }

        .btn:hover {
            background: #2d8e47;
        }

        .sign-in-section {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        #buttonDiv {
            display: inline-block;
            margin-top: 20px;
        }

        .accounts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .account-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .account-card:hover {
            border-color: #4285f4;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }

        .account-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .account-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }

        .account-info h3 {
            font-size: 16px;
            margin-bottom: 4px;
            color: #333;
        }

        .account-info p {
            font-size: 12px;
            color: #888;
        }

        .account-details {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 12px;
        }

        .account-details p {
            margin: 5px 0;
            word-break: break-all;
        }

        .account-details strong {
            color: #555;
        }

        .btn-remove {
            margin-top: 15px;
            padding: 8px 16px;
            background: #ea4335;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-remove:hover {
            background: #d33426;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .token-display {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            max-height: 100px;
            overflow-y: auto;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Google Identity Services Demo</h1>
            <p>Multi-Account Sign-In with Google's Modern Authentication</p>
            <p><a href="google-identity-services-guide.md" target="_blank" style="color: white; text-decoration: underline;">üìñ Read Full Documentation</a></p>
        </div>

        <div class="info-box">
            <h3>üìã Setup Instructions</h3>
            <ul>
                <li>Go to <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a></li>
                <li>Create OAuth 2.0 credentials (Web application)</li>
                <li>Add <strong>Authorized JavaScript origins:</strong> <code>https://gestures-techs.github.io</code></li>
                <li>For localhost: <code>http://localhost:8080</code></li>
                <li>Copy your Client ID and paste below</li>
            </ul>
        </div>

        <div class="main-content">
            <div class="config-section">
                <h2>‚öôÔ∏è Configuration</h2>
                <div class="input-group">
                    <label for="clientId">Google OAuth Client ID:</label>
                    <input 
                        type="text" 
                        id="clientId" 
                        placeholder="xxxxxxxxxxxx-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com"
                        value="">
                </div>
                <button class="btn" onclick="saveAndInitialize()">üíæ Save & Initialize</button>
            </div>

            <div class="sign-in-section">
                <h2>üë§ Sign In with Google</h2>
                <p>Click the button below to add a Google account</p>
                <div id="buttonDiv"></div>
                <p style="margin-top: 15px; font-size: 12px; color: #666;">
                    Using Google Identity Services (One Tap & Sign-In Button)
                </p>
            </div>

            <div>
                <h2>üë• Connected Accounts (<span id="accountCount">0</span>)</h2>
                <div id="accountsGrid" class="accounts-grid">
                    <div class="empty-state">
                        <h3>No accounts connected yet</h3>
                        <p>Sign in to add accounts</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Account storage
        let accounts = [];
        let clientId = '';

        // Load saved data
        function loadSavedData() {
            const savedClientId = localStorage.getItem('gis_client_id');
            const savedAccounts = localStorage.getItem('gis_accounts');
            
            if (savedClientId) {
                clientId = savedClientId;
                document.getElementById('clientId').value = clientId;
            }
            
            if (savedAccounts) {
                accounts = JSON.parse(savedAccounts);
                renderAccounts();
            }
        }

        // Save configuration and initialize Google Identity Services
        function saveAndInitialize() {
            console.log('=== SAVE AND INITIALIZE ===');
            const inputClientId = document.getElementById('clientId').value.trim();
            console.log('Input Client ID:', inputClientId);
            
            if (!inputClientId) {
                console.error('No Client ID provided');
                alert('Please enter a Client ID');
                return;
            }
            
            clientId = inputClientId;
            localStorage.setItem('gis_client_id', clientId);
            console.log('Client ID saved to localStorage');
            
            // Initialize Google Identity Services
            initializeGIS();
            
            alert('‚úÖ Configuration saved! You can now sign in.');
        }

        // Initialize Google Identity Services
        function initializeGIS() {
            console.log('=== INITIALIZE GIS ===');
            if (!clientId) {
                console.error('Client ID not configured');
                return;
            }

            console.log('Initializing Google Identity Services with Client ID:', clientId);

            google.accounts.id.initialize({
                client_id: clientId,
                callback: handleCredentialResponse,
                auto_select: false,
                cancel_on_tap_outside: true
            });
            console.log('GIS initialize() called');

            // Render the Sign-In button
            console.log('Rendering sign-in button...');
            google.accounts.id.renderButton(
                document.getElementById("buttonDiv"),
                { 
                    theme: "outline", 
                    size: "large",
                    text: "signin_with",
                    shape: "rectangular",
                    logo_alignment: "left"
                }
            );
            console.log('Sign-in button rendered');

            // Show One Tap prompt
            console.log('Showing One Tap prompt...');
            google.accounts.id.prompt((notification) => {
                console.log('One Tap notification:', notification);
            });

            console.log('=== GIS INITIALIZATION COMPLETE ===');
        }

        // Handle credential response
        function handleCredentialResponse(response) {
            console.log("Received credential response");
            console.log("JWT ID Token:", response.credential);

            try {
                // Decode the JWT to get user info
                const payload = JSON.parse(atob(response.credential.split('.')[1]));
                
                console.log('Decoded payload:', payload);
                console.log('User ID:', payload.sub);
                console.log('Name:', payload.name);
                console.log('Email:', payload.email);
                console.log('Picture:', payload.picture);

                // Create account object
                const account = {
                    id: payload.sub,
                    email: payload.email,
                    name: payload.name,
                    picture: payload.picture,
                    givenName: payload.given_name,
                    familyName: payload.family_name,
                    jwtToken: response.credential,
                    addedAt: Date.now(),
                    // Additional payload fields
                    emailVerified: payload.email_verified,
                    locale: payload.locale,
                    issuer: payload.iss,
                    audience: payload.aud,
                    issuedAt: payload.iat,
                    expiresAt: payload.exp
                };

                // Check if account already exists
                const existingIndex = accounts.findIndex(a => a.id === account.id);
                if (existingIndex >= 0) {
                    console.log('Updating existing account');
                    accounts[existingIndex] = account;
                    alert(`‚úÖ Account updated: ${account.name} (${account.email})`);
                } else {
                    console.log('Adding new account');
                    accounts.push(account);
                    alert(`‚úÖ Successfully signed in as ${account.name} (${account.email})`);
                }

                // Save accounts
                localStorage.setItem('gis_accounts', JSON.stringify(accounts));

                // Render accounts
                renderAccounts();

            } catch (error) {
                console.error('Error processing credential:', error);
                alert('Failed to process sign-in. Check console for details.');
            }
        }

        // Render accounts
        function renderAccounts() {
            const grid = document.getElementById('accountsGrid');
            const countElement = document.getElementById('accountCount');
            
            countElement.textContent = accounts.length;

            if (accounts.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>No accounts connected yet</h3>
                        <p>Sign in to add accounts</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = accounts.map((account, index) => {
                const expiryDate = new Date(account.expiresAt * 1000);
                const isExpired = Date.now() > (account.expiresAt * 1000);

                return `
                    <div class="account-card">
                        <div class="account-header">
                            ${account.picture ? 
                                `<img src="${account.picture}" alt="${account.name}" class="account-avatar">` :
                                `<div class="account-avatar" style="background: #4285f4; color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold;">
                                    ${account.name.charAt(0).toUpperCase()}
                                </div>`
                            }
                            <div class="account-info">
                                <h3>${account.name}</h3>
                                <p>${account.email}</p>
                                <p style="color: ${isExpired ? '#ea4335' : '#34a853'}; font-size: 10px; margin-top: 5px;">
                                    ${isExpired ? '‚ö†Ô∏è Token Expired' : '‚úì Token Valid'}
                                </p>
                            </div>
                        </div>

                        <div class="account-details">
                            <p><strong>User ID:</strong> ${account.id}</p>
                            <p><strong>Email Verified:</strong> ${account.emailVerified ? 'Yes' : 'No'}</p>
                            <p><strong>Locale:</strong> ${account.locale || 'N/A'}</p>
                            <p><strong>Added:</strong> ${new Date(account.addedAt).toLocaleString()}</p>
                            <p><strong>Token Expires:</strong> ${expiryDate.toLocaleString()}</p>
                            
                            <div class="token-display">
                                <strong>JWT Token:</strong><br>
                                ${account.jwtToken.substring(0, 100)}...
                            </div>
                        </div>

                        <button class="btn-remove" onclick="removeAccount(${index})">
                            üóëÔ∏è Remove Account
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Remove account
        function removeAccount(index) {
            if (confirm('Are you sure you want to remove this account?')) {
                const account = accounts[index];
                console.log('Removing account:', account.email);
                
                accounts.splice(index, 1);
                localStorage.setItem('gis_accounts', JSON.stringify(accounts));
                renderAccounts();
            }
        }

        // Initialize on page load
        window.onload = function() {
            console.log('Page loaded, initializing...');
            loadSavedData();
            
            // Wait for Google Identity Services library to load
            if (typeof google !== 'undefined' && google.accounts) {
                if (clientId) {
                    initializeGIS();
                }
            } else {
                console.log('Waiting for Google Identity Services to load...');
                setTimeout(() => {
                    if (clientId) {
                        initializeGIS();
                    }
                }, 1000);
            }
        };

        // Log for debugging
        console.log('Script loaded');
    </script>
</body>
</html>
