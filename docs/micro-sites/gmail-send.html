<!DOCTYPE html>
<html>
<head>
    <title>Gmail Send - Multi-Account</title>
</head>
<body>
    <h1>Gmail Send - Multi-Account</h1>
    <p><a href="gmail-send-guide.md" target="_blank">üìñ Read Documentation</a></p>
    
    <h3>Setup</h3>
    <p>Add to Google Console: Authorized JavaScript origins: https://gestures-techs.github.io</p>
    <p><strong>Required Scope:</strong> gmail.send</p>
    
    <div>
        <label>Client ID:</label><br>
        <input type="text" id="clientId" size="60"><br>
        <label>Redirect URI:</label><br>
        <input type="text" id="redirectUri" size="60"><br>
        <button onclick="app.saveConfig()">Save</button>
    </div>
    
    <hr>
    
    <h2>Accounts (<span id="count">0</span>)</h2>
    <button onclick="app.addAccount()">+ Add Account</button>
    
    <div id="accountsList"></div>
    
    <hr>
    
    <h2>Send Email</h2>
    <div>
        <label>From Account:</label><br>
        <select id="fromAccount">
            <option value="">-- Select Account --</option>
        </select><br><br>
        
        <label>To:</label><br>
        <input type="email" id="toEmail" placeholder="recipient@example.com" size="60"><br><br>
        
        <label>Subject:</label><br>
        <input type="text" id="subject" placeholder="Email subject" size="60"><br><br>
        
        <label>Message:</label><br>
        <textarea id="message" rows="10" cols="62" placeholder="Email body..."></textarea><br><br>
        
        <button onclick="app.sendEmail()">üìß Send Email</button>
    </div>
    
    <div id="sendStatus"></div>

    <script>
        const app = {
            config: {
                clientId: '',
                redirectUri: window.location.origin + window.location.pathname,
                scope: 'https://www.googleapis.com/auth/gmail.send https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile'
            },
            accounts: [],

            generateRandomState() {
                const randomValues = new Uint32Array(2);
                window.crypto.getRandomValues(randomValues);
                const utf8Encoder = new TextEncoder();
                const utf8Array = utf8Encoder.encode(
                    String.fromCharCode.apply(null, randomValues)
                );
                return btoa(String.fromCharCode.apply(null, utf8Array))
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=+$/, '');
            },

            init() {
                console.log('=== GMAIL SEND INIT START ===');
                console.log('Current URL:', window.location.href);
                console.log('URL Hash:', window.location.hash);
                console.log('URL Search:', window.location.search);
                
                const savedConfig = localStorage.getItem('gmailSendConfig');
                console.log('Saved config:', savedConfig);
                if (savedConfig) {
                    this.config = { ...this.config, ...JSON.parse(savedConfig) };
                    console.log('Config loaded:', this.config);
                    document.getElementById('clientId').value = this.config.clientId;
                    document.getElementById('redirectUri').value = this.config.redirectUri;
                }

                const savedAccounts = localStorage.getItem('gmailSendAccounts');
                console.log('Saved accounts:', savedAccounts);
                if (savedAccounts) {
                    this.accounts = JSON.parse(savedAccounts);
                    console.log('Loaded', this.accounts.length, 'accounts');
                }

                console.log('Checking for OAuth callback...');
                this.handleOAuthCallback();

                this.renderAccounts();
                this.updateAccountDropdown();

                if (!document.getElementById('redirectUri').value) {
                    console.log('Auto-populating redirect URI:', this.config.redirectUri);
                    document.getElementById('redirectUri').value = this.config.redirectUri;
                }
                console.log('=== GMAIL SEND INIT COMPLETE ===');
            },

            saveConfig() {
                console.log('=== SAVE CONFIG START ===');
                const clientId = document.getElementById('clientId').value.trim();
                const redirectUri = document.getElementById('redirectUri').value.trim();
                console.log('Client ID:', clientId);
                console.log('Redirect URI:', redirectUri);

                if (!clientId) {
                    console.error('No Client ID provided');
                    alert('Please enter a Client ID');
                    return;
                }

                if (!redirectUri) {
                    console.error('No Redirect URI provided');
                    alert('Please enter a Redirect URI');
                    return;
                }

                this.config.clientId = clientId;
                this.config.redirectUri = redirectUri;
                console.log('Config updated:', this.config);

                const configToSave = {
                    clientId: this.config.clientId,
                    redirectUri: this.config.redirectUri
                };
                console.log('Saving to localStorage:', configToSave);
                localStorage.setItem('gmailSendConfig', JSON.stringify(configToSave));
                console.log('Config saved successfully');
                console.log('=== SAVE CONFIG COMPLETE ===');

                alert('‚úÖ Configuration saved!');
            },

            async addAccount() {
                console.log('=== ADD ACCOUNT START ===');
                console.log('Current config:', this.config);
                
                if (!this.config.clientId) {
                    console.error('No Client ID configured');
                    alert('Please configure your Client ID first!');
                    return;
                }

                const state = this.generateRandomState();
                console.log('Generated state:', state);
                localStorage.setItem('gmail_send_oauth_state', state);
                console.log('State saved to localStorage');

                const authUrl = new URL('https://accounts.google.com/o/oauth2/v2/auth');
                authUrl.searchParams.append('client_id', this.config.clientId);
                authUrl.searchParams.append('redirect_uri', this.config.redirectUri);
                authUrl.searchParams.append('response_type', 'token');
                authUrl.searchParams.append('scope', this.config.scope);
                authUrl.searchParams.append('state', state);
                authUrl.searchParams.append('include_granted_scopes', 'true');
                authUrl.searchParams.append('prompt', 'select_account');

                console.log('OAuth URL:', authUrl.toString());
                console.log('Redirecting to Google OAuth...');
                console.log('=== ADD ACCOUNT - REDIRECTING ===');
                
                window.location.href = authUrl.toString();
            },

            async handleOAuthCallback() {
                const urlParams = new URLSearchParams(window.location.search);
                const authCode = urlParams.get('code');
                
                if (authCode) {
                    console.error('Received authorization code instead of access token');
                    alert('‚ùå Configuration Error: OAuth client not configured for Implicit Flow.\n\n' +
                          'Add "Authorized JavaScript origins" in Google Cloud Console.');
                    window.history.replaceState({}, document.title, window.location.pathname);
                    return;
                }

                const hash = window.location.hash.substring(1);
                if (!hash) return;

                console.log('=== OAUTH CALLBACK ===');
                console.log('Hash:', hash);

                const params = new URLSearchParams(hash);
                const accessToken = params.get('access_token');
                const expiresIn = params.get('expires_in');
                const state = params.get('state');
                const scope = params.get('scope');

                console.log('Access token:', accessToken ? 'Present' : 'Missing');
                console.log('State:', state);
                console.log('Scope:', scope);

                if (!accessToken) {
                    console.error('No access token in callback');
                    return;
                }

                const storedState = localStorage.getItem('gmail_send_oauth_state');
                if (state !== storedState) {
                    console.error('State mismatch. Possible CSRF attack');
                    alert('Security error: State mismatch');
                    return;
                }

                try {
                    const grantedScopes = scope ? scope.split(' ') : [];
                    console.log('Granted scopes:', grantedScopes);

                    // Check if gmail.send scope was granted
                    if (!grantedScopes.includes('https://www.googleapis.com/auth/gmail.send')) {
                        console.error('Gmail send scope not granted');
                        alert('‚ö†Ô∏è Gmail send permission not granted. Please try again and allow all permissions.');
                        localStorage.removeItem('gmail_send_oauth_state');
                        window.history.replaceState({}, document.title, window.location.pathname);
                        return;
                    }

                    const userInfo = await this.getUserInfo(accessToken);
                    console.log('User info received:', userInfo);

                    const account = {
                        id: userInfo.email,
                        email: userInfo.email,
                        name: userInfo.name,
                        picture: userInfo.picture,
                        accessToken: accessToken,
                        expiresAt: Date.now() + (parseInt(expiresIn) * 1000),
                        grantedScopes: grantedScopes,
                        addedAt: Date.now()
                    };

                    console.log('Account object:', account);

                    const existingIndex = this.accounts.findIndex(a => a.id === account.id);
                    if (existingIndex >= 0) {
                        console.log('Updating existing account at index:', existingIndex);
                        this.accounts[existingIndex] = account;
                    } else {
                        console.log('Adding new account');
                        this.accounts.push(account);
                    }

                    this.saveAccounts();
                    console.log('Accounts saved. Total:', this.accounts.length);
                    
                    this.renderAccounts();
                    this.updateAccountDropdown();
                    console.log('UI updated');

                    alert(`‚úÖ Successfully added ${userInfo.name} (${userInfo.email})`);

                    localStorage.removeItem('gmail_send_oauth_state');
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (error) {
                    console.error('Error in OAuth callback:', error);
                    alert('Failed to authenticate. Check console for details.');
                    localStorage.removeItem('gmail_send_oauth_state');
                }
            },

            async getUserInfo(accessToken) {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                return await response.json();
            },

            saveAccounts() {
                console.log('=== SAVING ACCOUNTS ===');
                console.log('Accounts to save:', this.accounts.length);
                console.log('Account data:', JSON.stringify(this.accounts, null, 2));
                localStorage.setItem('gmailSendAccounts', JSON.stringify(this.accounts));
                console.log('Accounts saved to localStorage');
            },

            removeAccount(accountId) {
                console.log('=== REMOVE ACCOUNT ===');
                console.log('Account ID:', accountId);
                if (confirm('Remove this account?')) {
                    const beforeCount = this.accounts.length;
                    this.accounts = this.accounts.filter(a => a.id !== accountId);
                    console.log('Accounts before:', beforeCount, 'After:', this.accounts.length);
                    this.saveAccounts();
                    this.renderAccounts();
                    this.updateAccountDropdown();
                    console.log('Account removed');
                } else {
                    console.log('Removal cancelled');
                }
            },

            isTokenExpired(account) {
                return Date.now() >= account.expiresAt;
            },

            renderAccounts() {
                document.getElementById('count').textContent = this.accounts.length;
                const list = document.getElementById('accountsList');

                if (this.accounts.length === 0) {
                    list.innerHTML = '<p>No accounts. Click "Add Account" to authorize Gmail sending.</p>';
                    return;
                }

                list.innerHTML = this.accounts.map(account => {
                    const isExpired = this.isTokenExpired(account);
                    return `
                        <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
                            ${account.picture ? `<img src="${account.picture}" width="40" height="40" style="border-radius: 50%;">` : ''}
                            <strong>${account.name || 'Google User'}</strong> - ${account.email}
                            <span style="color: ${isExpired ? 'red' : 'green'};">${isExpired ? '‚ö†Ô∏è Expired' : '‚úì Active'}</span>
                            <button onclick="app.removeAccount('${account.id}')">Remove</button>
                        </div>
                    `;
                }).join('');
            },

            updateAccountDropdown() {
                console.log('=== UPDATING ACCOUNT DROPDOWN ===');
                const select = document.getElementById('fromAccount');
                select.innerHTML = '<option value="">-- Select Account --</option>';
                
                this.accounts.forEach((account, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.text = `${account.name} (${account.email})`;
                    if (this.isTokenExpired(account)) {
                        option.text += ' [EXPIRED]';
                        option.disabled = true;
                    }
                    select.add(option);
                });
                console.log('Dropdown updated with', this.accounts.length, 'accounts');
            },

            async sendEmail() {
                console.log('=== SEND EMAIL START ===');
                const accountIndex = document.getElementById('fromAccount').value;
                const toEmail = document.getElementById('toEmail').value.trim();
                const subject = document.getElementById('subject').value.trim();
                const message = document.getElementById('message').value.trim();
                
                console.log('From account index:', accountIndex);
                console.log('To:', toEmail);
                console.log('Subject:', subject);
                console.log('Message length:', message.length);

                if (!accountIndex) {
                    console.error('No account selected');
                    alert('Please select a sender account');
                    return;
                }

                if (!toEmail) {
                    console.error('No recipient email');
                    alert('Please enter recipient email');
                    return;
                }

                if (!subject) {
                    console.error('No subject');
                    alert('Please enter email subject');
                    return;
                }

                if (!message) {
                    console.error('No message');
                    alert('Please enter email message');
                    return;
                }

                const account = this.accounts[parseInt(accountIndex)];
                console.log('Using account:', account.email);

                if (this.isTokenExpired(account)) {
                    console.error('Token expired for account:', account.email);
                    alert('Token expired. Please re-add this account.');
                    return;
                }

                const statusDiv = document.getElementById('sendStatus');
                statusDiv.innerHTML = '<p>Sending email...</p>';
                console.log('Status: Sending...');

                try {
                    // Create RFC 2822 formatted email
                    const email = [
                        `To: ${toEmail}`,
                        `Subject: ${subject}`,
                        '',
                        message
                    ].join('\r\n');
                    
                    console.log('Email formatted (RFC 2822)');
                    console.log('Email preview:', email.substring(0, 100) + '...');

                    // Encode email in base64url format
                    const encodedEmail = btoa(unescape(encodeURIComponent(email)))
                        .replace(/\+/g, '-')
                        .replace(/\//g, '_')
                        .replace(/=+$/, '');
                    
                    console.log('Email encoded (base64url)');
                    console.log('Encoded length:', encodedEmail.length);

                    // Send via Gmail API
                    console.log('Calling Gmail API send endpoint...');
                    const response = await fetch('https://www.googleapis.com/gmail/v1/users/me/messages/send', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${account.accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            raw: encodedEmail
                        })
                    });

                    console.log('Response status:', response.status);
                    console.log('Response status text:', response.statusText);

                    const result = await response.json();
                    console.log('Response data:', result);

                    if (response.ok) {
                        console.log('‚úÖ Email sent successfully!');
                        console.log('Message ID:', result.id);
                        console.log('Thread ID:', result.threadId);
                        
                        statusDiv.innerHTML = `
                            <p style="color: green;">‚úÖ Email sent successfully!</p>
                            <p>Message ID: ${result.id}</p>
                            <p>From: ${account.email}</p>
                            <p>To: ${toEmail}</p>
                        `;
                        
                        // Clear form
                        document.getElementById('toEmail').value = '';
                        document.getElementById('subject').value = '';
                        document.getElementById('message').value = '';
                        
                        console.log('Form cleared');
                        console.log('=== SEND EMAIL SUCCESS ===');
                        
                    } else {
                        console.error('‚ùå Failed to send email');
                        console.error('Error:', result);
                        statusDiv.innerHTML = `<p style="color: red;">‚ùå Failed to send: ${result.error?.message || 'Unknown error'}</p>`;
                        console.log('=== SEND EMAIL FAILED ===');
                    }
                } catch (error) {
                    console.error('‚ùå Error sending email:', error);
                    console.error('Error stack:', error.stack);
                    statusDiv.innerHTML = `<p style="color: red;">‚ùå Error: ${error.message}</p>`;
                    console.log('=== SEND EMAIL ERROR ===');
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
